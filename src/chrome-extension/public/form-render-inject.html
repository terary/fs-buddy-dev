<html>
	<head>
    <style>
      .fsBuddy_obscure {
          opacity: 0.5;
      }
      .fsBuddy_lightblue {
          opacity: 0.5;
          background-color: lightblue;
      }
      .fsBuddy_lightgreen {
          opacity: 0.5;
          background-color: lightgreen;
      }
      /* ----------------------------------------------------- */

      .fsBuddy_statusContainer {
          opacity: 0.5;
      }
  
  
      .fsBuddy_statusRowHeader
      {
          /*padding-left: 2em;*/
      }
  
      .fsBuddy_statusRow
      {
          padding-left: 1em;
      }
  
      .fsBuddy_statusRow_hidden
      {
          display: none;
      }
  
      .fsBuddy_statusMessateCell_
      {}
      .fsBuddy_statusMessateCell_severity,
      .fsBuddy_statusMessateCell_message {
          display: inline
      }
  
      .fsBuddy_statusMessateCell_fieldId, 
      .fsBuddy_statusMessateCell_relatedFieldIds {
          display: none;
      }
  
      .fsBuddy_statusMessate_severity_debug {
          background-color: pink;
      }
  
      .fsBuddy_statusMessate_severity_info{
          background-color: lightblue;
      }
  
      .fsBuddy_statusMessate_severity_warn{
          background-color: yellow;
      }
  
      .fsBuddy_statusMessate_severity_error {
          background-color: red;
      }
  
      .fsBuddy_statusMessate_link {
          color: blue;
          /*background-color: red;*/
          text-decoration: underline;
      }
  
    </style>
  <script>
    window.onmessage = function(e) {
    // listen/receive message  
      switch(e.data.messageType) {
        case 'addCssClassToFieldIdList':
          addCssClassToFields(e.data.payload.cssClassName, e.data.payload.fieldIds)
          break;
        case 'removeClassFromFieldIdList':
          removeCssClassFromFields(e.data.payload.cssClassName, e.data.payload.fieldIds)
          break;
          
        case 'getFieldStatusesResponse': 
          handelGetFieldStatusesResponse(e.data.payload)
        break;


        case 'pong':
          console.log({ping:'pong', message: e.data.payload});
          break;

        case 'removeAllClassName':
          removeAllCssName(e.data.payload.cssClassName)
          break;
        // case 'getFieldStatuses':
        //   processFieldStatuses(e.data.payload.statusMessages)
        //   break;
        case 'getFieldsWithLogicResponse':
          handleGetFieldsWithLogicResponse(e.data.payload)
          break;
        case 'getFieldLogicDependentsResponse':
          handleGetFieldLogicDependentsResponse(e.data.payload)
          break;

          
      }
      console.log({'messageReceived': e})
    };

    function sendMessageToParent(messageType, payload){
      let message;
      switch(messageType){
        case 'getFieldsWithLogicRequest':
            message = {
              messageType: "getFieldsWithLogicRequest",
              payload: 'ping'
            }
          break;
          
          case 'removeFsBuddyRequest':
            message = {
              messageType: "removeFsBuddyRequest",
              payload:  null
            }
          break;
//getFieldStatuses
          case 'getFieldStatusesRequest':
            message = {
              messageType: "getFieldStatusesRequest",
              payload: payload || null
            }
          break;
          case 'getFieldLogicDependentsRequest':
            message = {
              messageType: "getFieldLogicDependentsRequest",
              payload: payload || null
            }
          break;
        default:
          message = {
            messageType: "ping",
            payload: 'ping'
          }
      }

      window.top.postMessage(message, '*')
		}

      const addCssClassToFields = (cssClassName, fieldIds) => {
        console.log({function:'addCssClassToFields', cssClassName, fieldIds})
          fieldIds.forEach(fieldId=>{
              const fieldContainer =  getFieldContainer(fieldId);
              if(fieldContainer.parentElement) {
                fieldContainer.parentElement.classList.add(cssClassName);        
              } else { // hack, this is likely a "section" field
                fieldContainer.classList.add(cssClassName);        
              }
          });
      }

      const removeCssClassFromFields = (cssClassName, fieldIds) => {
        console.log({function:'removeCssClassFromFields', cssClassName, fieldIds})
          fieldIds.forEach(fieldId=>{
              const fieldContainer =  getFieldContainer(fieldId);
              fieldContainer.parentElement.classList.remove(cssClassName);        
              fieldContainer.classList.remove(cssClassName);        
          });
      }



      const handleGetFieldStatusClick = ()=>{
        sendMessageToParent('getFieldStatusesRequest', {})
      }

      const handleFieldIdSelected = (selectElementId, selectedValue)=>{
        console.log({selectElementId, selectedValue})
        sendMessageToParent('getFieldLogicDependentsRequest', {fieldId: selectedValue})
      }
 
      const handleGetFieldsWithLogicResponse = (fieldIds) => {
        const divWithSelect = optionListToSelectElement('selectFieldIdWithLogic', handleFieldIdSelected, fieldIds.fieldIds)
        const logicBuddyContainer = document.getElementById('fsBuddyControlPanelLogic');
        logicBuddyContainer.appendChild(divWithSelect);
        console.log('Load FieldIds'); 
        console.log({fieldIds});
      }

      const removeAllCssName = (cssClassName) => {
        document.querySelectorAll(`.${cssClassName}`).forEach(el=>{
            el.classList.remove(cssClassName);
        })    
      }

      const handleGetFieldLogicDependentsResponse = (payload)=>{
        removeAllCssName('fsHidden')
        removeAllCssName('fsBuddy_lightblue')
        addCssClassToFields('fsBuddy_lightblue', payload.fieldIds)

        console.log({message: 'show these, hide others', payload})
      }

      const handelGetFieldStatusesResponse = (payload)=>{
        const {statusMessages} = payload || {};
        Object.entries(statusMessages).forEach(([fieldId, statusMessages])=>{
          appendFieldStatusContainer(fieldId, statusMessages.statusMessages)
        })
      }

// -----------------------------------
      const SEVERITIES = {
        error: 0,
        warn: 50,
        info: 100,
        debug: 500,
        0: 'error',
        50: 'warn',
        100: 'info',
        500: 'debug',
      }

      const collapseAllFsBuddyStatusItems = ()=>{
        const statusContainers = document.querySelectorAll('.fsBuddy_statusRow')
        statusContainers.forEach(container=>container.classList.add('fsBuddy_statusRow_hidden'))
      }
    
      const expandAllFsBuddyStatusItems = ()=>{
          const statusContainers = document.querySelectorAll('.fsBuddy_statusRow')
          statusContainers.forEach(container=>container.classList.remove('fsBuddy_statusRow_hidden'))
      }
    
      const toggleExpandCollapseStatusItems  = (fieldId)=>{
        const containerId = `fsBuddy_statusContainer_${fieldId}`;
        const fieldContainer = document.getElementById(containerId);
        const hiddenRows = fieldContainer.querySelectorAll('.fsBuddy_statusRow_hidden');

        if(hiddenRows.length===0){
            fieldContainer.querySelectorAll('.fsBuddy_statusRow').forEach(row=>{
                row.classList.add('fsBuddy_statusRow_hidden')
            })
        } else {
            hiddenRows.forEach(row=>{
                row.classList.remove('fsBuddy_statusRow_hidden')
            })
        }
      }

      const getMessageCollectionSeverity = (statusMessages) => {
        let collectionSeverity = SEVERITIES['debug'];
        (statusMessages || []).forEach(message=>{
            if(SEVERITIES[message.severity] <  collectionSeverity) {
                collectionSeverity = SEVERITIES[message.severity];
            }
        })
        return SEVERITIES[collectionSeverity];
      }
  
      const removeFsBuddyStatusContainers = ()=>{
        const statusContainers = document.querySelectorAll('.fsBuddy_statusContainer')
        statusContainers.forEach(container=>container.remove())
      }

      const getFieldContainer = (fieldId)=>{
        // I think all fields are in a section, 
        // but a section does not always contain fields - maybe
        const containerId =`fsCell${fieldId}`;
        const sectionId =`fsSection${fieldId}`;
        
        return document.getElementById(containerId) || document.getElementById(sectionId);
        //fsSection126381010

      }
      
      const appendFieldStatusContainer = (fieldId, statusMessages)=>{
        const containerId =`fsCell${fieldId}`;
        const fieldContainer = getFieldContainer(fieldId);

        // document.getElementById(containerId);

        const collectionSeverity = getMessageCollectionSeverity(statusMessages);




        const statusContainer = document.createElement('div');
        statusContainer.id = `fsBuddy_statusContainer_${fieldId}`;
        statusContainer.classList.add('fsBuddy_statusContainer');

        const divStatusHeadRow = document.createElement('div');
        divStatusHeadRow.classList.add(`fsBuddy_statusRowHeader`);
        divStatusHeadRow.classList.add(`fsBuddy_statusMessate_severity_${collectionSeverity}`);
        
        
        const aExpandCollapseItemsLink = document.createElement('a');
        aExpandCollapseItemsLink.innerHTML = `<a>expand/collapse</a> fieldId: ${fieldId} FS Buddy (${statusMessages.length})`;
        aExpandCollapseItemsLink.onclick = ()=>{toggleExpandCollapseStatusItems(fieldId)}
        aExpandCollapseItemsLink.classList.add('fsBuddy_statusMessate_link');

        divStatusHeadRow.appendChild(aExpandCollapseItemsLink)
        statusContainer.appendChild(divStatusHeadRow)
        
      //        {severity:'debug', message: 'The debug message', fieldId: '148111228',  relatedFieldIds:['147738154', '148111228', '147738157']},
        statusMessages.forEach(message=>{
            const divStatusRow = document.createElement('div');
            divStatusRow.classList.add(`fsBuddy_statusRow`);
            divStatusRow.classList.add(`fsBuddy_statusMessate_severity_${message['severity']}`);
            ['severity', 'message', 'fieldId', 'relatedFieldIds'].forEach(messagePart=>{
                const divMessagePart = document.createElement('div');
                switch(messagePart){
                    case "severity":
                        divMessagePart.classList.add(`fsBuddy_statusMessateCell_severity`);
                        divMessagePart.innerHTML = `<span>(${message[messagePart]})</span>`;
                    break;
                    default:
                        divMessagePart.classList.add(`fsBuddy_statusMessateCell_${messagePart}`);
                        divMessagePart.innerHTML = `<span>${message[messagePart]}</span>`;
                    break; // <-- never stops being funny
                    
                }
                divStatusRow.appendChild(divMessagePart);
            })
            statusContainer.appendChild(divStatusRow)
        })
        
        if(statusContainer.querySelector('.fsRow')) {
          // its not a section
          if (fieldContainer.parentElement) {
            fieldContainer.parentElement.prepend(statusContainer)
          } else {
              fieldContainer.prepend(statusContainer)
          }
  
        } else {
          // its a section         
          fieldContainer.appendChild(statusContainer)
        }
        
        

      }

      function optionListToSelectElement(elementId, onSelectHandler, options){
        if(!Array.isArray(options)) {
          console.log({message: 'options not an array', options});
          return
        }


        const div = document.createElement('div');
        div.id = `${elementId}-container`;
        const selectHandlerWrapper = (evt)=>{
            onSelectHandler(evt.target.id, evt.target.value)
        }
            
        const theSelect = document.createElement('select');
        (options || []).forEach(option=>{
            const theOption = document.createElement('option');
            theOption.value = option.value;
            theOption.innerText = option.label;
            theSelect.appendChild(theOption);
        })
        theSelect.onchange = selectHandlerWrapper;
        theSelect.id = elementId;
        div.appendChild(theSelect)
        return div;
      }


// -----------------------------------
// this creates the window?

      const buildFsBuddyControlPanel = ()=>{
        document.getElementById('fsBuddyFieldStatusesContainer') && document.getElementById('fsBuddyFieldStatusesContainer').remove()

        const theBody = document.querySelector('body');

        const fsBuddyFieldStatusesContainer = document.createElement('div');
        fsBuddyFieldStatusesContainer.id='fsBuddyFieldStatusesContainer'
        theBody.prepend(fsBuddyFieldStatusesContainer);

        // const removeFsBuddyFieldStatusContainersButton = document.createElement('button');
        // removeFsBuddyFieldStatusContainersButton.innerText = 'Remove Status Containers';
        // removeFsBuddyFieldStatusContainersButton.onclick = (e)=>{
        //   e.stopPropagation();
        //   removeFsBuddyStatusContainers();
        //   return false;
        // };
        // fsBuddyFieldStatusesContainer.prepend(removeFsBuddyFieldStatusContainersButton);

        // const expandFsBuddyFieldStatusItemsButton = document.createElement('button');
        // expandFsBuddyFieldStatusItemsButton.innerText = 'Expand Field Status Items';
        // expandFsBuddyFieldStatusItemsButton.onclick = (e)=>{
        //         e.stopPropagation();
        //         expandAllFsBuddyStatusItems();
        //         return false;
        // };
        // fsBuddyFieldStatusesContainer.prepend(expandFsBuddyFieldStatusItemsButton);

        // const collapseFsBuddyFieldStatusItemsButton = document.createElement('button');
        // collapseFsBuddyFieldStatusItemsButton.innerText = 'Collapse Field Status Items';
        // collapseFsBuddyFieldStatusItemsButton.onclick = (e)=>{
        //         e.stopPropagation();
        //         collapseAllFsBuddyStatusItems();
        //         return false;
        // };
        // fsBuddyFieldStatusesContainer.prepend(collapseFsBuddyFieldStatusItemsButton);

        // const fieldsWithLogicButton = document.createElement('button');
        // fieldsWithLogicButton.innerText = 'Get Fields With Logic';
        // fieldsWithLogicButton.onclick = (e)=>{
        //     sendMessageToParent('getFieldsWithLogicRequest')
        //     console.log('Get Field IDs of fields With Logic.')
        //       // e.stopPropagation();
        //         // collapseAllFsBuddyStatusItems();
        //         return false;
        // };
        // fsBuddyFieldStatusesContainer.prepend(fieldsWithLogicButton);
      }

    //   const processFieldStatuses = (statusMessages)=>{
    //     Object.entries(statusMessages).forEach(([fieldId, statusMessages])=>{
    //       appendFieldStatusContainer(fieldId, statusMessages.statusMessages)
    //     })
    //  }
    
     document.addEventListener("DOMContentLoaded",()=>{
      buildFsBuddyControlPanel()
     })


     function removeFsBuddy(){
      sendMessageToParent('removeFsBuddyRequest')
     }

    function showOnly(showPanelId){
      [
        'fsBuddyControlPanelLogic', 
        'fsBuddyControlPanelFieldStatus'
      ].forEach(panelId=>{
        document.getElementById(panelId).style.display = "none";
      })
        document.getElementById(showPanelId).style.display = "block";
          
          
    }
	</script>
	</head>
	<body>
    <div id="fsBuddyControllPannel">
      FS Buddy Control Panel
      <button onclick="removeFsBuddy()">Remove FS Buddy</button>
      <button onclick="showOnly('fsBuddyControlPanelLogic')">Work with Logic</button>
      <button onclick="showOnly('fsBuddyControlPanelFieldStatus')">Work with Field Messages</button>
  
      <div id='fsBuddyControlPanelLogic'>
            <h3>Logic</h3>
            Put some logic stuff in here<br />
            <button onclick="sendMessageToParent('getFieldsWithLogicRequest')">Get Fields With Logic</button>

      </div>
      <div id='fsBuddyControlPanelFieldStatus'>
            <h3>Field Status</h3>
            Put some field status in here<br />
            <button onclick="handleGetFieldStatusClick()">Get Field Statuses</button>&nbsp;&nbsp;&nbsp;
            <button onclick="collapseAllFsBuddyStatusItems()">Collapse Statuses</button>&nbsp;&nbsp;&nbsp;
            <button onclick="expandAllFsBuddyStatusItems()">Expand Statuses</button><br />
            <button onclick="removeFsBuddyStatusContainers()">Remove Status Containers</button><br />
            
            <button onclick="removeAllCssName('fsHidden')">Remove All fsHidden</button><br />
            <button onclick="removeAllCssName('fsBuddy_obscure'); removeAllCssName('fsBuddy_lightblue');removeAllCssName('fsBuddy_lightgreen');">Remove All fsBuddy</button><br />
      </div>
    </div>
    
	</body>
</html>